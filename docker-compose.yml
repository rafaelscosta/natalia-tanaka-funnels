services:
  init:
    image: alpine:latest
    container_name: natalia-funnels-init
    command:
      - sh
      - -c
      - |
        apk add --no-cache wget
        mkdir -p /data/mpo
        BASEURL="https://raw.githubusercontent.com/rafaelscosta/natalia-tanaka-funnels/master"
        wget -q -O /data/mpo/index.html "$BASEURL/mpo/index.html"
        wget -q -O /data/mpo/oferta-especial.html "$BASEURL/mpo/oferta-especial.html"
        wget -q -O /data/mpo/alternativa.html "$BASEURL/mpo/alternativa.html"
        wget -q -O /data/mpo/obrigado.html "$BASEURL/mpo/obrigado.html"
        echo "Done"; ls -la /data/mpo/
    volumes:
      - funnel-data:/data

  nginx:
    image: nginx:alpine
    container_name: natalia-funnels
    restart: unless-stopped
    depends_on:
      init:
        condition: service_completed_successfully
    ports:
      - "8080:80"
    volumes:
      - funnel-data:/usr/share/nginx/html:ro
    command:
      - sh
      - -c
      - |
        cat > /etc/nginx/conf.d/default.conf << 'NGINXEOF'
        server {
            listen 80;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            gzip on;
            gzip_types text/css application/javascript;
            gzip_min_length 1000;
            location /mpo/ {
                try_files $uri $uri/ /mpo/index.html;
            }
            location = / {
                return 301 /mpo/;
            }
            location ~ /\. {
                deny all;
                return 404;
            }
        }
        NGINXEOF
        nginx -g 'daemon off;'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/mpo/index.html"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

volumes:
  funnel-data:
